{% extends "layout.html" %}
{% block body %}
{% set category_titles = {
  '1': 'High Weightage',
  '2': 'Medium Weightage',
  '3': 'Low Weightage',
  '4': 'Foundation / Revision'
} %}
<a href="{{ url_for('index') }}" class="btn btn-link mb-3">&larr; Back</a>
<div class="card p-3 mb-3">
  <div class="d-flex align-items-center justify-content-between">
    <div>
      <h4 class="mb-0">{{ subject }}</h4>
      <div class="small-muted">Total Chapters: {{ subj.total }} â€¢ Overall progress: {{ subj.percent }}% ({{ subj.marked }}/{{ subj.max_possible }})</div>
    </div>
  </div>
  <div class="mt-3">
    <div class="progress" style="height:14px;">
      <div class="progress-bar" id="subject-progress" role="progressbar" style="width: {{ subj.percent }}%">{{ subj.percent }}%</div>
    </div>
  </div>
</div>

<!-- Subject-level Book Tracking -->
{% if subject == "Mathematics" and subj.subject_books %}
<div class="card p-3 mb-3">
  <h5 class="mb-3">Mathematics Books Completion</h5>
  <div class="d-flex flex-wrap gap-3">
    <div class="form-check">
      <input class="form-check-input check-small" type="checkbox" id="math_pinkbook" {% if subj.subject_books.pinkbook %}checked{% endif %} data-subject="Mathematics" data-field="pinkbook">
      <label class="form-check-label" for="math_pinkbook">Pink Book</label>
    </div>
    <div class="form-check">
      <input class="form-check-input check-small" type="checkbox" id="math_yellowbook" {% if subj.subject_books.yellowbook %}checked{% endif %} data-subject="Mathematics" data-field="yellowbook">
      <label class="form-check-label" for="math_yellowbook">Yellow Book</label>
    </div>
    <div class="form-check">
      <input class="form-check-input check-small" type="checkbox" id="math_play_with_graphs" {% if subj.subject_books.play_with_graphs %}checked{% endif %} data-subject="Mathematics" data-field="play_with_graphs">
      <label class="form-check-label" for="math_play_with_graphs">Play with Graphs</label>
    </div>
  </div>
</div>
{% endif %}

{% if subject == "Chemistry" and subj.subject_books %}
<div class="card p-3 mb-3">
  <h5 class="mb-3">Chemistry Books Completion</h5>
  <div class="d-flex flex-wrap gap-3">
    <div class="form-check">
      <input class="form-check-input check-small" type="checkbox" id="chem_n_awasthi" {% if subj.subject_books.n_awasthi %}checked{% endif %} data-subject="Chemistry" data-field="n_awasthi">
      <label class="form-check-label" for="chem_n_awasthi">N. Awasthi</label>
    </div>
    <div class="form-check">
      <input class="form-check-input check-small" type="checkbox" id="chem_ms_chauhan" {% if subj.subject_books.ms_chauhan %}checked{% endif %} data-subject="Chemistry" data-field="ms_chauhan">
      <label class="form-check-label" for="chem_ms_chauhan">MS Chauhan</label>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-3">
  {% for cat, chs in categories.items() %}
  <div class="col-12">
    <div class="card p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div>
          <span class="tag-cat">Category {{ cat }}</span>
          <strong class="ms-2">{{ category_titles.get(cat, '') }}</strong>
          <div class="small-muted">{{ chs|length }} chapters</div>
        </div>
        <div style="width:40%;">
          <div class="small-muted mb-1 text-end">Category progress</div>
          <div class="progress" style="height:12px;">
            <div class="progress-bar cat-progress" id="cat-{{ cat }}" style="width: {{ cat_progress[cat] }}%">{{ cat_progress[cat] }}%</div>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-borderless align-middle mb-0">
          <thead>
            <tr class="small-muted">
              <th style="width:35%;">Chapter</th>
              <th style="width:50%;">Actions</th>
              <th style="width:15%;">Progress</th>
            </tr>
          </thead>
          <tbody>
            {% for ch in chs %}
            <tr class="chapter-row">
              <td>
                <div><strong>{{ ch.index_in_list }}. {{ ch.title }}</strong></div>
                <div class="small-muted">Category: {{ ch.category }}</div>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <!-- Common Actions -->
                  <div class="form-check">
                    <input class="form-check-input check-small chapter-checkbox" type="checkbox" id="c_{{ ch.id }}_theory" {% if ch.theory %}checked{% endif %} data-id="{{ ch.id }}" data-field="theory">
                    <label class="form-check-label small-muted" for="c_{{ ch.id }}_theory">Theory</label>
                  </div>
                  
                  <div class="form-check">
                    <input class="form-check-input check-small chapter-checkbox" type="checkbox" id="c_{{ ch.id }}_pyqs" {% if ch.pyqs %}checked{% endif %} data-id="{{ ch.id }}" data-field="pyqs">
                    <label class="form-check-label small-muted" for="c_{{ ch.id }}_pyqs">PYQs</label>
                  </div>
                  
                  <div class="form-check">
                    <input class="form-check-input check-small chapter-checkbox" type="checkbox" id="c_{{ ch.id }}_module_a" {% if ch.module_a %}checked{% endif %} data-id="{{ ch.id }}" data-field="module_a">
                    <label class="form-check-label small-muted" for="c_{{ ch.id }}_module_a">Module A</label>
                  </div>

                  <div class="form-check">
                    <input class="form-check-input check-small chapter-checkbox" type="checkbox" id="c_{{ ch.id }}_module_b" {% if ch.module_b %}checked{% endif %} data-id="{{ ch.id }}" data-field="module_b">
                    <label class="form-check-label small-muted" for="c_{{ ch.id }}_module_b">Module B</label>
                  </div>
                  
                  <!-- Revision Counter with increment/decrement -->
                  <div class="d-flex align-items-center gap-1">
                    <button class="btn btn-sm btn-outline-danger revision-btn" data-id="{{ ch.id }}" data-action="decrement" {% if ch.revision_count == 0 %}disabled{% endif %}>-</button>
                    <span class="mx-2" title="Revision Count">Rev: <strong id="revision_{{ ch.id }}">{{ ch.revision_count }}</strong></span>
                    <button class="btn btn-sm btn-outline-success revision-btn" data-id="{{ ch.id }}" data-action="increment">+</button>
                  </div>

                  <!-- Subject-specific Actions -->
                  {% if subject == "Physics" %}
                  <div class="form-check">
                    <input class="form-check-input check-small chapter-checkbox" type="checkbox" id="c_{{ ch.id }}_physics_galaxy" {% if ch.physics_galaxy %}checked{% endif %} data-id="{{ ch.id }}" data-field="physics_galaxy">
                    <label class="form-check-label small-muted" for="c_{{ ch.id }}_physics_galaxy">Physics Galaxy</label>
                  </div>
                  {% elif subject == "Mathematics" %}
                  <div class="form-check">
                    <input class="form-check-input check-small chapter-checkbox" type="checkbox" id="c_{{ ch.id }}_cengage" {% if ch.cengage %}checked{% endif %} data-id="{{ ch.id }}" data-field="cengage">
                    <label class="form-check-label small-muted" for="c_{{ ch.id }}_cengage">Cengage</label>
                  </div>
                  {% endif %}
                </div>
              </td>
              <td>
                <div class="small-muted text-end mb-2">Completed: <strong id="chapprog-{{ ch.id }}">{{ ch.progress_count() }}/{{ ch.max_possible_progress() }}</strong></div>
                <div class="progress" style="height:10px;">
                  <div class="progress-bar" id="chapbar-{{ ch.id }}" style="width: {{ (ch.progress_count()/ch.max_possible_progress()*100)|round(0) }}%"></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}
